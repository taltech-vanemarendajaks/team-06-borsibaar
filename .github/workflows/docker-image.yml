name: Build and Deploy

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      SERVER_IP: ${{ secrets.SERVER_IP }}
      APP_PATH: ${{ secrets.APP_PATH }}
      ENV_PRODUCTION_FILE: ${{ secrets.ENV_PRODUCTION_FILE }}
      CERTBOT_EMAIL: ${{ secrets.CERTBOT_EMAIL }}
      DOMAIN: ${{ secrets.DOMAIN }}
      DOCKER_COMPOSE_FILE: docker-compose.prod.yaml

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Build and test backend
        working-directory: backend
        run: ./mvnw clean package

      - name: Set up Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Lint frontend
        working-directory: frontend
        run: npm run lint

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan "$SERVER_IP" >> ~/.ssh/known_hosts

      - name: Create .env.production from secret
        run: |
          printf '%s\n' "$ENV_PRODUCTION_FILE" > .env.production

      - name: Create deployment package
        run: |
          tar czf deployment.tar.gz \
            backend/target/*.jar \
            frontend/ \
            nginx/ \
            "$DOCKER_COMPOSE_FILE" \
            backend/Dockerfile \
            frontend/Dockerfile \
            .env.production

      - name: Copy deployment package to server
        run: |
          scp -i ~/.ssh/id_rsa \
            -o StrictHostKeyChecking=yes \
            deployment.tar.gz \
            "$SERVER_USER@$SERVER_IP:/tmp/"

      - name: Deploy on server
        run: |
          ssh -i ~/.ssh/id_rsa \
            -o StrictHostKeyChecking=yes \
            "$SERVER_USER@$SERVER_IP" << EOF
          set -e

          mkdir -p $APP_PATH
          cd $APP_PATH

          # Extract deployment package
          tar xzf /tmp/deployment.tar.gz
          rm /tmp/deployment.tar.gz

          # Check if docker-compose file exists
          if [ ! -f "$DOCKER_COMPOSE_FILE" ]; then
            echo "ERROR: $DOCKER_COMPOSE_FILE not found!"
            exit 1
          fi

          # Copy environment file if exists
          if [ -f .env.production ]; then
            cp .env.production .env
          fi

          # Clean/repair builder cache and avoid BuildKit flakiness
          # sudo systemctl restart docker
          # docker buildx prune -af || true
          # docker builder prune -af || true
          # docker image prune -af || true

          # Stop and remove existing containers gracefully
          docker compose -f "$DOCKER_COMPOSE_FILE" down --remove-orphans --timeout 15
          
          # Verify containers are gone
          project_name="borsibaar"
          if docker ps -a --filter "label=com.docker.compose.project=$project_name" --format '{{.Names}}' | grep .; then
            echo "ERROR: Containers still exist after graceful shutdown"
            docker ps -a --filter "label=com.docker.compose.project=$project_name" --format 'table {{.Names}}\t{{.Status}}'
            exit 1
          fi

          # Check if SSL certificates exist
          if [ ! -f "./certbot/conf/live/$DOMAIN/fullchain.pem" ]; then
            echo "SSL certificates not found. Starting with HTTP-only configuration..."
            
            # Disable HTTPS config and enable HTTP-only config
            mv nginx/conf.d/borsibaar-https.conf nginx/conf.d/borsibaar-https.conf.disabled 2>/dev/null || true
            mv nginx/conf.d/borsibaar-http-only.conf.disabled nginx/conf.d/borsibaar-http-only.conf 2>/dev/null || true
            
            # Rebuild and start containers
            docker compose -f "$DOCKER_COMPOSE_FILE" build --no-cache
            docker compose -f "$DOCKER_COMPOSE_FILE" up -d
            
            # Wait for nginx to be ready with timeout
            echo "Waiting for nginx to be ready..."
            TIMEOUT=30
            ELAPSED=0
            until docker compose -f "$DOCKER_COMPOSE_FILE" exec -T nginx test -f /var/run/nginx.pid 2>/dev/null; do
              if [ $ELAPSED -ge $TIMEOUT ]; then
                echo "ERROR: Nginx failed to start within ${TIMEOUT}s"
                docker compose -f "$DOCKER_COMPOSE_FILE" logs nginx
                exit 1
              fi
              echo "Waiting for nginx... (${ELAPSED}s/${TIMEOUT}s)"
              sleep 2
              ELAPSED=$((ELAPSED + 2))
            done
            echo "Nginx is ready!"
            
            # Generate SSL certificates (or use existing if valid)
            echo "Generating SSL certificates..."
            docker compose -f "$DOCKER_COMPOSE_FILE" run --rm --entrypoint certbot certbot certonly \
              --webroot \
              --webroot-path=/var/www/certbot \
              --email $CERTBOT_EMAIL \
              --agree-tos \
              --no-eff-email \
              --non-interactive \
              --keep-until-expiring \
              -d $DOMAIN
            
            # Start certbot renewal service
            docker compose -f "$DOCKER_COMPOSE_FILE" --profile renewal up -d certbot
            
            # Switch to HTTPS configuration
            echo "Switching to HTTPS configuration..."
            mv nginx/conf.d/borsibaar-http-only.conf nginx/conf.d/borsibaar-http-only.conf.disabled
            mv nginx/conf.d/borsibaar-https.conf.disabled nginx/conf.d/borsibaar-https.conf
            
            # Reload nginx to apply HTTPS configuration
            docker compose -f "$DOCKER_COMPOSE_FILE" exec -T nginx nginx -s reload
            
            echo "SSL certificates generated and HTTPS enabled!"
          else
            echo "SSL certificates found. Starting with HTTPS configuration..."
            
            # Ensure HTTPS config is enabled
            mv nginx/conf.d/borsibaar-http-only.conf nginx/conf.d/borsibaar-http-only.conf.disabled 2>/dev/null || true
            mv nginx/conf.d/borsibaar-https.conf.disabled nginx/conf.d/borsibaar-https.conf 2>/dev/null || true
            
            # Rebuild and start containers
            docker compose -f "$DOCKER_COMPOSE_FILE" build --no-cache
            docker compose -f "$DOCKER_COMPOSE_FILE" up -d
            
            # Start certbot renewal service
            docker compose -f "$DOCKER_COMPOSE_FILE" --profile renewal up -d certbot
          fi

          # Clean up old images
          # docker image prune -f

          echo "Deployment complete!"
          docker compose -f "$DOCKER_COMPOSE_FILE" ps
          EOF
